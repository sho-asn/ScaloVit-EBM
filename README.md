# ScaloVit-EBM Repository

This repository accompanies the paper **“ScaloVit-EBM: Localized Energy-Based Anomaly Detection on Time–Frequency Scalograms”**. It contains the code needed to preprocess the Cranfield three-phase flow dataset, train the ScaloVit-EBM model, reproduce ablations, and regenerate the figures and tables that appear in the manuscript.

## Repository Layout

- `preprocess_data.py`, `img_transformations.py`: data loading, detrending, and CWT scalogram generation.
- `train_ebm.py`, `train_ebm_ablation.py`: training entry points for the main FM-only model and the CD-augmented ablation.
- `detect_anomalies.py`, `detect_anomalies_ablation.py`, `anomaly_scoring.py`: inference, anomaly scoring, and metric computation.
- `ebm_model_vit.py`, `ebm_utils.py`, `metrics.py`, `ablation_models.py`: model definitions and shared utilities.
- `scripts/analysis/`: lightweight notebooks-in-script form for metric aggregation and qualitative analysis.
- `scripts/plotting/`: scripts to regenerate figures used in the paper (scalograms, t-SNE plots, workflow diagrams, etc.).
- `Notebooks/`: exploratory notebooks referenced during development (optional).
- `paper/`: LaTeX source, figures, and bibliography for the manuscript.
- `resources/`: literature survey notes cited in the paper.

## Setup

1. Create and activate a Python environment (Python ≥ 3.10).
2. Install dependencies via `requirements.txt`:

```bash
python -m pip install -r requirements.txt
```

## Data Preparation

1. Download the Cranfield three-phase flow facility dataset (CVACaseStudy/MFP).
2. Place the `.mat` files under `Datasets/CVACaseStudy/MFP/` (this folder is ignored by git).
3. Run preprocessing to detrend signals, generate CWT scalograms, and save chunked tensors. Example command (adjust paths/flags as needed):

```bash
python preprocess_data.py \
	--transform_type wavelet \
	--data_dir Datasets/CVACaseStudy/MFP \
	--output_dir preprocessed_dataset \
	--chunk_width 2048 \
	--chunk_stride 64 \
	--detrend --detrend_window_size 4096
```

## Training & Evaluation

Train the primary ScaloVit-EBM model (Energy Matching, FM-only):

```bash
python train_ebm.py \
	--train_data_path preprocessed_dataset/train_chunks_wavelet_mag.pt \
	--val_data_path preprocessed_dataset/val_chunks_wavelet_mag.pt \
	--output_dir results/ebm_fm
```

Evaluate on the test sets and compute metrics:

```bash
python detect_anomalies.py \
	--ckpt path/to/checkpoint.pt \
	--val_data_path preprocessed_dataset/val_chunks_wavelet_mag.pt \
	--test_data_dir preprocessed_dataset \
	--output_dir results/ebm_detection
```

To reproduce ablations (Contrastive Divergence, alternative heads, aggregation strategies), use the corresponding scripts:

```bash
python train_ebm_ablation.py --lambda_cd 0.001 --output_dir results/ebm_cd
python detect_anomalies_ablation.py --ckpt path/to/cd_checkpoint.pt --output_dir results/ebm_cd_detection
```

Per-signal anomaly scoring utilities live in `anomaly_scoring.py`, and shared evaluation metrics are in `metrics.py`.

## Regenerating Figures and Tables

All figure-generation scripts live under `scripts/plotting/`. Run them from the repository root once preprocessing and model evaluation outputs are available.

Examples:

```bash
python scripts/plotting/create_workflow_diagram_plots.py
python scripts/plotting/make_tsne_plot.py --ckpt path/to/checkpoint.pt
python scripts/analysis/analyze_detection_results.py results/ebm_detection/energy_scores.csv
```

Each script prints its required inputs and the destination paths for generated plots.

## Baseline Reproduction

- **PatchTrAD** and **LSTM EncDec-AD** are referenced but not bundled. Clone their official repositories if you wish to rerun those baselines and place them alongside this project (the scripts assume relative paths).

## Paper

Compile the LaTeX source under `paper/` to reproduce the manuscript:

```bash
cd paper
latexmk -pdf scaloVitEBM.tex
```

Figures needed for the paper are generated by the plotting scripts above and saved under `paper/figures/`.

## Contributing / Issues

Please open an issue on GitHub if you encounter problems recreating the experiments or if a dependency/version pin is missing.